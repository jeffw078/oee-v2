<!-- templates/soldagem/apontamento.html - VERS√ÉO COMPLETA COM PARADAS -->
{% extends 'base.html' %}

{% block title %}Sistema de Apontamento OEE{% endblock %}

{% block extra_css %}
<style>
    .status-connection {
        position: absolute;
        top: 10px;
        right: 120px;
        color: #28a745;
        font-weight: bold;
    }
    
    .status-connection.offline {
        color: #dc3545;
    }
    
    .timer-large {
        font-size: 3rem;
        font-weight: bold;
        color: #dc3545;
        text-align: center;
        margin: 20px 0;
    }
    
    .greeting {
        font-size: 1.5rem;
        text-align: center;
        margin: 20px 0;
        color: #6c757d;
    }
    
    .module-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 30px 0;
    }
    
    .module-btn {
        padding: 20px;
        font-size: 1.2rem;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .module-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 20px 0;
    }
    
    .control-btn {
        padding: 15px;
        font-size: 1rem;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-qualidade { background: #28a745; }
    .btn-parada { background: #6c757d; }
    .btn-finalizar { background: #dc3545; }
    .btn-manutencao { background: #ffc107; color: #000; }
    
    .working-area {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
    }
    
    .working-details {
        font-size: 1.1rem;
        margin: 10px 0;
    }
    
    .process-timer {
        font-size: 2rem;
        font-weight: bold;
        color: #dc3545;
        margin: 15px 0;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: none;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
        background: #dc3545;
        color: white;
        padding: 15px 20px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
    }
    
    .close:hover {
        opacity: 0.7;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-primary {
        background: #dc3545;
        color: white;
    }
    
    .paused-indicator {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        color: #856404;
    }
    
    .component-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .component-btn {
        padding: 15px;
        font-size: 0.9rem;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        background: #dc3545;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .component-btn:hover {
        background: #c82333;
        transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
        .timer-large {
            font-size: 2rem;
        }
        
        .module-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .component-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .modal-content {
            width: 95%;
            margin: 5% auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Indicador de conex√£o -->
<div id="connectionStatus" class="status-connection">
    üü¢ Conectado
</div>

<!-- Rel√≥gio e sauda√ß√£o -->
<div class="timer-large" id="currentTime">{{ now|date:"H:i:s" }}</div>
<div class="greeting">{{ saudacao }}, {{ soldador.usuario.nome_completo }}!</div>

<!-- √Årea de trabalho quando h√° apontamento em andamento -->
{% if apontamento_atual %}
<div class="working-area">
    <h3>Soldagem em Andamento: {{ apontamento_atual.modulo.nome }}</h3>
    
    <div class="working-details">
        <strong>Pedido:</strong> {{ apontamento_atual.pedido.numero }} | 
        <strong>Poste/Tubo:</strong> {{ apontamento_atual.numero_poste_tubo }}
    </div>
    
    {% if apontamento_atual.diametro %}
    <div class="working-details">
        <strong>Di√¢metro do Tubo:</strong> {{ apontamento_atual.diametro }} mm
    </div>
    {% endif %}
    
    <div class="working-details">
        <strong>Componente:</strong> {{ apontamento_atual.componente.nome }} | 
        <strong>In√≠cio:</strong> {{ apontamento_atual.inicio_processo|date:"H:i:s" }}
    </div>
    
    <div class="process-timer" id="processTimer">Tempo decorrido: 00:00:00</div>
    
    <!-- Bot√£o finalizar atividade -->
    <button class="control-btn btn-finalizar" onclick="finalizarComponente()" style="font-size: 1.2rem; padding: 15px 30px;">
        ‚úì Finalizar Atividade
    </button>
    
    <!-- Bot√µes de controle durante processo -->
    <div class="control-grid">
        <button class="control-btn btn-parada" onclick="abrirModalParada()">
            ‚è∏ Pausa
        </button>
        <button class="control-btn btn-qualidade" onclick="abrirModalQualidade()">
            üîç Qualidade
        </button>
        <button class="control-btn btn-manutencao" onclick="abrirModalManutencao()">
            üîß Manuten√ß√£o
        </button>
    </div>
</div>

<!-- √Årea de parada ativa -->
{% elif parada_atual %}
<div class="paused-indicator">
    <h3>‚è∏ PARADA ATIVA</h3>
    <div><strong>Tipo:</strong> {{ parada_atual.tipo_parada.nome }}</div>
    <div><strong>In√≠cio:</strong> {{ parada_atual.inicio|date:"H:i:s" }}</div>
    <div class="process-timer" id="pauseTimer">Tempo de parada: 00:00:00</div>
    
    <button class="control-btn btn-finalizar" onclick="finalizarParada()">
        ‚ñ∂ Retomar Atividade
    </button>
</div>

<!-- Sele√ß√£o de m√≥dulos -->
{% else %}
<div class="module-grid">
    {% for modulo in modulos %}
    <button class="module-btn" style="background: #dc3545;" onclick="selecionarModulo({{ modulo.id }}, '{{ modulo.nome }}')">
        {{ modulo.nome }}
    </button>
    {% endfor %}
</div>

<!-- Bot√µes de controle gerais -->
<div class="control-grid">
    <button class="control-btn btn-qualidade" onclick="abrirModalQualidade()">
        üîç Qualidade
    </button>
    <button class="control-btn btn-parada" onclick="abrirModalParada()">
        ‚è∏ Parada
    </button>
    <button class="control-btn btn-manutencao" onclick="abrirModalManutencao()">
        üîß Manuten√ß√£o
    </button>
    <button class="control-btn btn-finalizar" onclick="finalizarTurno()">
        üö™ Finalizar Turno
    </button>
</div>
{% endif %}

<!-- Modal de sele√ß√£o de m√≥dulo -->
<div id="modalModulo" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Dados do Processo</h3>
            <button class="close" onclick="fecharModal('modalModulo')">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="pedidoInput">N√∫mero do Pedido:</label>
            <input type="text" id="pedidoInput" class="form-control" placeholder="Ex: 12345">
        </div>
        
        <div class="form-group">
            <label for="posteInput">N√∫mero do Poste/Tubo:</label>
            <input type="text" id="posteInput" class="form-control" placeholder="Ex: 001">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalModulo')">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarModulo()">Continuar</button>
        </div>
    </div>
</div>

<!-- Modal de sele√ß√£o de componente -->
<div id="modalComponente" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tituloComponente">Componentes do M√≥dulo</h3>
            <button class="close" onclick="fecharModal('modalComponente')">&times;</button>
        </div>
        
        <div id="componentesList" class="component-grid">
            <!-- Componentes ser√£o carregados via JavaScript -->
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalComponente')">Voltar</button>
        </div>
    </div>
</div>

<!-- Modal de di√¢metro -->
<div id="modalDiametro" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Di√¢metro do Tubo</h3>
            <button class="close" onclick="fecharModal('modalDiametro')">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="diametroInput">Di√¢metro (mm):</label>
            <input type="number" id="diametroInput" class="form-control" placeholder="Ex: 800">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalDiametro')">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarDiametro()">Iniciar Soldagem</button>
        </div>
    </div>
</div>

<!-- Modal de parada -->
<div id="modalParada" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Pausa durante Soldagem</h3>
            <button class="close" onclick="fecharModal('modalParada')">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="motivoParada">Motivo da pausa:</label>
            <select id="motivoParada" class="form-control">
                <option value="">Carregando...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="detalheParada">Detalhes (opcional):</label>
            <textarea id="detalheParada" class="form-control" rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalParada')">Cancelar</button>
            <button class="btn btn-primary" onclick="iniciarParada()">Iniciar Pausa</button>
        </div>
    </div>
</div>

<!-- Modal de qualidade -->
<div id="modalQualidade" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Avalia√ß√£o de Qualidade durante Soldagem</h3>
            <button class="close" onclick="fecharModal('modalQualidade')">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="senhaQualidade">Senha de Qualidade:</label>
            <input type="password" id="senhaQualidade" class="form-control" placeholder="Digite a senha">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalQualidade')">Cancelar</button>
            <button class="btn btn-primary" onclick="acessarQualidade()">Acessar</button>
        </div>
    </div>
</div>

<!-- Modal de manuten√ß√£o -->
<div id="modalManutencao" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Parada para Manuten√ß√£o</h3>
            <button class="close" onclick="fecharModal('modalManutencao')">&times;</button>
        </div>
        
        <div class="form-group">
            <label for="senhaManutencao">Senha de Manuten√ß√£o:</label>
            <input type="password" id="senhaManutencao" class="form-control" placeholder="Digite a senha">
        </div>
        
        <div class="form-group">
            <label for="motivoManutencao">Motivo da Manuten√ß√£o:</label>
            <select id="motivoManutencao" class="form-control">
                <option value="">Carregando...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="detalheManutencao">Detalhes:</label>
            <textarea id="detalheManutencao" class="form-control" rows="3" placeholder="Descreva o problema..."></textarea>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="fecharModal('modalManutencao')">Cancelar</button>
            <button class="btn btn-primary" onclick="iniciarManutencao()">Iniciar Manuten√ß√£o</button>
        </div>
    </div>
</div>

<!-- Vari√°veis JavaScript -->
<script>
// Vari√°veis globais
let moduloSelecionado = null;
let componenteSelecionado = null;
let apontamentoAtual = {% if apontamento_atual %}{{ apontamento_atual.id }}{% else %}null{% endif %};
let paradaAtual = {% if parada_atual %}{{ parada_atual.id }}{% else %}null{% endif %};
let inicioProcesso = {% if apontamento_atual %}"{{ apontamento_atual.inicio_processo|date:'c' }}"{% else %}null{% endif %};
let inicioParada = {% if parada_atual %}"{{ parada_atual.inicio|date:'c' }}"{% else %}null{% endif %};

// Atualizar rel√≥gio
function atualizarRelogio() {
    const agora = new Date();
    const horas = agora.getHours().toString().padStart(2, '0');
    const minutos = agora.getMinutes().toString().padStart(2, '0');
    const segundos = agora.getSeconds().toString().padStart(2, '0');
    
    document.getElementById('currentTime').textContent = `${horas}:${minutos}:${segundos}`;
}

// Atualizar timer do processo
function atualizarTimerProcesso() {
    if (!inicioProcesso) return;
    
    const inicio = new Date(inicioProcesso);
    const agora = new Date();
    const diff = agora - inicio;
    
    const horas = Math.floor(diff / 3600000);
    const minutos = Math.floor((diff % 3600000) / 60000);
    const segundos = Math.floor((diff % 60000) / 1000);
    
    const timer = document.getElementById('processTimer');
    if (timer) {
        timer.textContent = `Tempo decorrido: ${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    }
}

// Atualizar timer da parada
function atualizarTimerParada() {
    if (!inicioParada) return;
    
    const inicio = new Date(inicioParada);
    const agora = new Date();
    const diff = agora - inicio;
    
    const horas = Math.floor(diff / 3600000);
    const minutos = Math.floor((diff % 3600000) / 60000);
    const segundos = Math.floor((diff % 60000) / 1000);
    
    const timer = document.getElementById('pauseTimer');
    if (timer) {
        timer.textContent = `Tempo de parada: ${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    }
}

// Verificar conex√£o
function verificarConexao() {
    const status = document.getElementById('connectionStatus');
    
    fetch('/soldagem/api/buscar_tipos_parada/?categoria=geral')
        .then(response => {
            if (response.ok) {
                status.textContent = 'üü¢ Conectado';
                status.className = 'status-connection';
            } else {
                throw new Error('Sem conex√£o');
            }
        })
        .catch(() => {
            status.textContent = 'üî¥ Offline';
            status.className = 'status-connection offline';
        });
}

// Fun√ß√µes de modal
function abrirModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    
    // Limpar campos
    const modal = document.getElementById(modalId);
    const inputs = modal.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.type === 'text' || input.type === 'number' || input.type === 'password' || input.tagName === 'TEXTAREA') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
    });
}

// Sele√ß√£o de m√≥dulo
function selecionarModulo(moduloId, moduloNome) {
    moduloSelecionado = moduloId;
    document.getElementById('pedidoInput').focus();
    abrirModal('modalModulo');
}

function confirmarModulo() {
    const pedido = document.getElementById('pedidoInput').value.trim();
    const poste = document.getElementById('posteInput').value.trim();
    
    if (!pedido || !poste) {
        alert('‚ùå Preencha todos os campos obrigat√≥rios');
        return;
    }
    
    // Enviar dados do m√≥dulo
    fetch('/soldagem/api/iniciar_modulo/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            modulo_id: moduloSelecionado,
            pedido: pedido,
            poste: poste
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fecharModal('modalModulo');
            carregarComponentes(data.componentes, data.modulo_nome);
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function carregarComponentes(componentes, moduloNome) {
    document.getElementById('tituloComponente').textContent = `Componentes do ${moduloNome}`;
    
    const lista = document.getElementById('componentesList');
    lista.innerHTML = '';
    
    componentes.forEach(comp => {
        const button = document.createElement('button');
        button.className = 'component-btn';
        button.innerHTML = `<strong>${comp.nome}</strong><br><small>(${comp.tempo_padrao}min)</small>`;
        button.onclick = () => selecionarComponente(comp);
        lista.appendChild(button);
    });
    
    abrirModal('modalComponente');
}

function selecionarComponente(componente) {
    componenteSelecionado = componente;
    fecharModal('modalComponente');
    
    if (componente.considera_diametro) {
        abrirModal('modalDiametro');
    } else {
        iniciarComponente(null);
    }
}

function confirmarDiametro() {
    const diametro = document.getElementById('diametroInput').value;
    
    if (!diametro || diametro <= 0) {
        alert('‚ùå Digite um di√¢metro v√°lido');
        return;
    }
    
    fecharModal('modalDiametro');
    iniciarComponente(diametro);
}

function iniciarComponente(diametro) {
    const dados = {
        componente_id: componenteSelecionado.id,
        diametro: diametro
    };
    
    fetch('/soldagem/api/iniciar_componente/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarregar p√°gina para mostrar processo em andamento
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function finalizarComponente() {
    if (!apontamentoAtual) {
        alert('‚ùå Nenhum apontamento em andamento');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è Confirma a finaliza√ß√£o da atividade?')) {
        return;
    }
    
    fetch('/soldagem/api/finalizar_componente/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            apontamento_id: apontamentoAtual
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Atividade finalizada!\nTempo: ${data.tempo_real.toFixed(1)} min\nEfici√™ncia: ${data.eficiencia.toFixed(1)}%`);
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

// Fun√ß√µes de parada
function abrirModalParada() {
    // Carregar tipos de parada gerais
    fetch('/soldagem/api/buscar_tipos_parada/?categoria=geral')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('motivoParada');
                select.innerHTML = '<option value="">Selecione um motivo</option>';
                
                data.tipos_parada.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id;
                    option.textContent = tipo.nome;
                    select.appendChild(option);
                });
                
                abrirModal('modalParada');
            }
        })
        .catch(error => {
            alert(`‚ùå Erro ao carregar tipos de parada: ${error.message}`);
        });
}

function iniciarParada() {
    const tipoParadaId = document.getElementById('motivoParada').value;
    const motivo = document.getElementById('detalheParada').value;
    
    if (!tipoParadaId) {
        alert('‚ùå Selecione um motivo para a parada');
        return;
    }
    
    fetch('/soldagem/api/iniciar_parada/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            tipo_parada_id: tipoParadaId,
            motivo_detalhado: motivo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fecharModal('modalParada');
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function finalizarParada() {
    if (!paradaAtual) {
        alert('‚ùå Nenhuma parada em andamento');
        return;
    }
    
    fetch('/soldagem/api/finalizar_parada/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            parada_id: paradaAtual
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Parada finalizada!\nDura√ß√£o: ${data.duracao_minutos.toFixed(1)} minutos`);
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

// Fun√ß√µes de qualidade e manuten√ß√£o
function abrirModalQualidade() {
    abrirModal('modalQualidade');
    document.getElementById('senhaQualidade').focus();
}

function acessarQualidade() {
    const senha = document.getElementById('senhaQualidade').value;
    
    if (!senha) {
        alert('‚ùå Digite a senha de qualidade');
        return;
    }
    
    // Iniciar parada de qualidade
    fetch('/soldagem/api/iniciar_parada/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            tipo_parada_id: 1, // ID do tipo de parada de qualidade (deve ser configurado)
            senha_especial: senha
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fecharModal('modalQualidade');
            window.open('/qualidade/painel/', '_blank');
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function abrirModalManutencao() {
    // Carregar tipos de parada de manuten√ß√£o
    fetch('/soldagem/api/buscar_tipos_parada/?categoria=manutencao')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('motivoManutencao');
                select.innerHTML = '<option value="">Selecione um motivo</option>';
                
                data.tipos_parada.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id;
                    option.textContent = tipo.nome;
                    select.appendChild(option);
                });
                
                abrirModal('modalManutencao');
                document.getElementById('senhaManutencao').focus();
            }
        })
        .catch(error => {
            alert(`‚ùå Erro ao carregar tipos de manuten√ß√£o: ${error.message}`);
        });
}

function iniciarManutencao() {
    const senha = document.getElementById('senhaManutencao').value;
    const tipoParadaId = document.getElementById('motivoManutencao').value;
    const motivo = document.getElementById('detalheManutencao').value;
    
    if (!senha) {
        alert('‚ùå Digite a senha de manuten√ß√£o');
        return;
    }
    
    if (!tipoParadaId) {
        alert('‚ùå Selecione um motivo para a manuten√ß√£o');
        return;
    }
    
    fetch('/soldagem/api/iniciar_parada/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            tipo_parada_id: tipoParadaId,
            motivo_detalhado: motivo,
            senha_especial: senha
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fecharModal('modalManutencao');
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function finalizarTurno() {
    if (!confirm('‚ö†Ô∏è Confirma a finaliza√ß√£o do turno?')) {
        return;
    }
    
    window.location.href = '/soldagem/finalizar_turno/';
}

function getCsrfToken() {
    const metaTag = document.querySelector('[name=csrfmiddlewaretoken]');
    if (metaTag) return metaTag.value;
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    
    const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (hiddenInput) return hiddenInput.value;
    
    return '';
}

// Eventos do teclado
document.addEventListener('keydown', function(e) {
    // ESC para fechar modais
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });
    }
    
    // Enter nos inputs de senha
    if (e.key === 'Enter') {
        if (e.target.id === 'senhaQualidade') {
            acessarQualidade();
        } else if (e.target.id === 'senhaManutencao') {
            iniciarManutencao();
        }
    }
});

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    // Timers
    setInterval(atualizarRelogio, 1000);
    setInterval(atualizarTimerProcesso, 1000);
    setInterval(atualizarTimerParada, 1000);
    setInterval(verificarConexao, 5000);
    
    // Verificar conex√£o inicial
    verificarConexao();
    
    // Fechar modais clicando fora
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    };
});
</script>
{% endblock %}