{% extends 'base.html' %}

{% block title %}Sele√ß√£o de Soldador - OEE{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="text-center mb-4" style="color: var(--primary-red);">
                Selecione o Soldador
            </h2>
            
            <div class="row">
                {% for soldador in soldadores %}
                <div class="col-md-6 col-lg-4">
                    <div class="soldador-card" onclick="selecionarSoldador({{ soldador.id }}, '{{ soldador.usuario.nome_completo }}')">
                        <div class="soldador-nome">{{ soldador.usuario.nome_completo }}</div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-warning text-center">
                        <h4>‚ö†Ô∏è Nenhum soldador encontrado!</h4>
                        <p>Execute: <code>python criar_dados_iniciais.py</code></p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para senha -->
<div class="modal fade" id="modalSenha" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Digite sua senha</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="senha" class="form-label">Soldador: <strong><span id="soldador-nome"></span></strong></label>
                    <input type="password" class="form-control form-control-lg text-center" 
                           id="senha" maxlength="10" style="font-size: 1.5rem;" placeholder="Digite sua senha">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarLogin()">
                    <span id="spinner" style="display: none;">üîÑ</span>
                    Entrar
                </button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

{% endblock %}

{% block extra_js %}
<script>
let soldadorSelecionado = null;

function selecionarSoldador(soldadorId, nome) {
    soldadorSelecionado = soldadorId;
    document.getElementById('soldador-nome').textContent = nome;
    document.getElementById('senha').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('modalSenha'));
    modal.show();
    
    setTimeout(() => {
        document.getElementById('senha').focus();
    }, 500);
}

function confirmarLogin() {
    const senha = document.getElementById('senha').value;
    
    if (!senha.trim()) {
        alert('Digite a senha');
        document.getElementById('senha').focus();
        return;
    }
    
    document.getElementById('spinner').style.display = 'inline-block';
    
    const dadosLogin = {
        soldador_id: soldadorSelecionado,
        senha: senha
    };
    
    fetch('/login_soldador/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(dadosLogin),
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('spinner').style.display = 'none';
        
        if (data.success) {
            window.location.href = data.redirect || '/apontamento/';
        } else {
            alert(`‚ùå Erro no login: ${data.message || 'Erro desconhecido'}`);
        }
    })
    .catch(error => {
        document.getElementById('spinner').style.display = 'none';
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}

function getCsrfToken() {
    const metaTag = document.querySelector('[name=csrfmiddlewaretoken]');
    if (metaTag) {
        return metaTag.value;
    }
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (hiddenInput) {
        return hiddenInput.value;
    }
    
    return '';
}

// Enter para confirmar senha
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('senha').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmarLogin();
        }
    });
});
</script>
{% endblock %}